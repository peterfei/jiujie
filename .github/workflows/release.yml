name: 多平台自动构建打包

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: bevy_card_battler_linux
            binary_name: bevy_card_battler
          - os: windows-latest
            artifact_name: bevy_card_battler_windows
            binary_name: bevy_card_battler.exe
          - os: macos-latest
            artifact_name: bevy_card_battler_macos
            binary_name: bevy_card_battler

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: 安装 Rust 工具链
        uses: dtolnay/rust-toolchain@stable

      - name: 缓存 Rust 依赖
        uses: Swatinem/rust-cache@v2

      - name: 安装 Linux 依赖 (仅 Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y g++ pkg-config libx11-dev libasound2-dev libudev-dev libwayland-dev libxkbcommon-dev

      - name: 执行 Release 编译
        run: cargo build --release

      - name: 准备打包目录
        shell: bash
        run: |
          mkdir -p build_dist
          if [ "${{ matrix.os }}" == "macos-latest" ]; then
            # macOS App Bundle 逻辑
            APP_NAME="九界：渡劫"
            mkdir -p "build_dist/${APP_NAME}.app/Contents/MacOS"
            mkdir -p "build_dist/${APP_NAME}.app/Contents/Resources"
            cp target/release/bevy_card_battler "build_dist/${APP_NAME}.app/Contents/MacOS/"
            cp -r assets "build_dist/${APP_NAME}.app/Contents/Resources/"
            [ -f assets/icons/icon.icns ] && cp assets/icons/icon.icns "build_dist/${APP_NAME}.app/Contents/Resources/AppIcon.icns"
            
            cat > "build_dist/${APP_NAME}.app/Contents/Info.plist" <<EOF
            <?xml version="1.0" encoding="UTF-8"?>
            <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
            <plist version="1.0">
            <dict>
                <key>CFBundleExecutable</key>
                <string>bevy_card_battler</string>
                <key>CFBundleIconFile</key>
                <string>AppIcon.icns</string>
                <key>CFBundleIdentifier</key>
                <string>com.peterfei.bevy-card-battler</string>
                <key>CFBundleName</key>
                <string>九界：渡劫</string>
                <key>CFBundlePackageType</key>
                <string>APPL</string>
                <key>LSMinimumSystemVersion</key>
                <string>10.12</string>
            </dict>
            </plist>
            EOF
          else
            # Windows / Linux 绿色包逻辑
            cp target/release/${{ matrix.binary_name }} build_dist/
            cp -r assets build_dist/
          fi

      - name: 构建 Windows MSI 安装包 (仅限 Windows)
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          cargo install cargo-wix --version 0.3.10
          # 动态初始化并打包，不使用硬编码路径
          cargo wix init
          cargo wix --no-build
          cp target/wix/*.msi build_dist/

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: build_dist/
