name: 多平台自动构建打包

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_NAME: bevy_card_battler
  DISPLAY_NAME: 九界：渡劫

jobs:
  # ==================== Windows 构建 ====================
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: 安装 Rust
        uses: dtolnay/rust-toolchain@stable
      - name: 缓存依赖
        uses: Swatinem/rust-cache@v2
      - name: 编译 Release
        run: cargo build --release
      - name: 准备打包目录
        shell: bash
        run: |
          mkdir -p build_dist
          cp target/release/${{ env.PROJECT_NAME }}.exe build_dist/
          cp -r assets build_dist/
      - name: 构建 MSI 安装包
        shell: bash
        run: |
          cargo install cargo-wix --version 0.3.10
          # 初始化并指定二进制路径，确保 wix 能找到文件
          cargo wix init
          cargo wix --no-build
          cp target/wix/*.msi build_dist/
      - name: 上传 Windows 产物
        uses: actions/upload-artifact@v4
        with:
          name: bevy_card_battler_windows
          path: build_dist/

  # ==================== macOS 构建 ====================
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: 安装 Rust
        uses: dtolnay/rust-toolchain@stable
      - name: 缓存依赖
        uses: Swatinem/rust-cache@v2
      - name: 编译 Release
        # 显式禁止 ALSA 链接，确保 macOS 纯净编译
        run: cargo build --release
      - name: 准备 App Bundle
        shell: bash
        run: |
          APP_NAME="${{ env.DISPLAY_NAME }}"
          mkdir -p "build_dist/${APP_NAME}.app/Contents/MacOS"
          mkdir -p "build_dist/${APP_NAME}.app/Contents/Resources"
          cp target/release/${{ env.PROJECT_NAME }} "build_dist/${APP_NAME}.app/Contents/MacOS/"
          cp -r assets "build_dist/${APP_NAME}.app/Contents/Resources/"
          [ -f assets/icons/icon.icns ] && cp assets/icons/icon.icns "build_dist/${APP_NAME}.app/Contents/Resources/AppIcon.icns"
          
          cat > "build_dist/${APP_NAME}.app/Contents/Info.plist" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>${{ env.PROJECT_NAME }}</string>
              <key>CFBundleIconFile</key>
              <string>AppIcon.icns</string>
              <key>CFBundleIdentifier</key>
              <string>com.peterfei.bevy-card-battler</string>
              <key>CFBundleName</key>
              <string>${{ env.DISPLAY_NAME }}</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>LSMinimumSystemVersion</key>
              <string>10.12</string>
          </dict>
          </plist>
          EOF
      - name: 上传 macOS 产物
        uses: actions/upload-artifact@v4
        with:
          name: bevy_card_battler_macos
          path: build_dist/

  # ==================== Linux 构建 ====================
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: 安装 Rust
        uses: dtolnay/rust-toolchain@stable
      - name: 缓存依赖
        uses: Swatinem/rust-cache@v2
      - name: 安装依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y g++ pkg-config libx11-dev libasound2-dev libudev-dev libwayland-dev libxkbcommon-dev
      - name: 编译 Release
        run: cargo build --release
      - name: 准备打包目录
        shell: bash
        run: |
          mkdir -p build_dist
          cp target/release/${{ env.PROJECT_NAME }} build_dist/
          cp -r assets build_dist/
      - name: 上传 Linux 产物
        uses: actions/upload-artifact@v4
        with:
          name: bevy_card_battler_linux
          path: build_dist/