# 研发笔记：关于“金丹期视野回退”事件的深度复盘

## 事件背景
在实现“筑基期特权”功能后，用户反馈当境界提升至“金丹期”时，大地图视野反而缩减到了炼气期水平（2层），且地图标题下方的境界描述错误显示为“凡人”。

## 为什么 TDD 和集成测试没能拦截此 Bug？

### 1. 局部验证陷阱 (Feature-Specific Testing)
*   **现象**：我们的 TDD 测试（`cultivation_privilege_tdd.rs`）只针对“从炼气到筑基”的跨越进行了逻辑验证。
*   **教训**：测试不仅要验证“增量”，还要验证“连续性”。对于等级/境界这种线性增长的功能，应该编写**参数化测试**，覆盖从低到高的所有已知维度。

### 2. UI 渲染与业务逻辑的耦合
*   **现象**：视野计算逻辑被直接硬编码在 `setup_map_ui` 系统中，而现有的测试主要关注 `struct` 的内部数值。
*   **教训**：**核心业务算法必须抽离 UI**。境界与视野的映射关系应该是一个可独立测试的纯函数（Pure Function），而不是 UI 系统的副作用。

### 3. 通配符匹配的副作用 (The Evil of Wildcard Match)
*   **现象**：在 Rust 的 `match` 语句中过度依赖 `_ => ...` 来处理未实现的境界。
*   **教训**：在处理核心业务等级时，应尽量**显式枚举所有变体**。使用 `_` 相当于告诉编译器“我不在乎剩下的情况”，这会导致新增境界（变体）时，编译器无法通过“穷举检查”发出警告。

### 4. 测试样板规模不足 (Scale Masking)
*   **现象**：测试环境下地图默认仅为 3 层，而筑基视野已经覆盖了 2 层。
*   **教训**：小规模数据会掩盖算法边界错误。压力测试或大规模样板测试（例如生成 100 层地图进行视野断言）应包含在集成测试中。

### 5. 缺乏负面与边界测试
*   **现象**：只测试了“是筑基期如何”，没测试“更高境界是否保持优势”。
*   **教训**：必须包含单调性测试（Monotonicity Test），确保关键属性随境界只增不减。

## 改进措施
1.  **重构代码**：将 `get_vision_range(realm)` 逻辑移至 `Cultivation` 组件中，并为其编写独立单元测试。
2.  **强制穷举**：在涉及境界奖励的代码块中，移除 `_` 匹配，改为显式匹配所有 `Realm` 变体。
3.  **完善集成测试**：在 `map_interactions_e2e.rs` 中增加对多层级（>5层）地图的渲染节点数量校验。

---
*记录时间：2026-01-25*
*记录人：IfAI 开发助手*
