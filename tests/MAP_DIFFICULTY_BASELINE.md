# 地图难度缩放与回归测试基线说明

## 1. 核心设计变更
为了提升游戏的进阶挑战感，我们实现了动态难度缩放系统。敌人的强度不再是静态的，而是随着玩家在地图中的探索深度（Layer）动态增强。

### 数值缩放模型
- **道行 (HP)**: `基础值 * (1.0 + 层级 * 0.15)`
- **武功 (Strength)**: `层级 / 3` (每3层增加1点基础攻击力)
- **防御度 (Block)**: `(层级 / 2) * 2` (每2层增加2点初始护甲)
- **AI 进化**: 敌人的伤害和护甲范围随 Strength 同步提升。
- **Boss 强化**: Boss 节点在上述缩放基础上，额外获得 `+2 Strength` 和 `+5 Block`。

## 2. 测试基线 (Baseline)
我们在 `tests/difficulty_baseline_tdd.rs` 中确立了以下标准数值基线：

| 深度层级 | 典型敌人 (狼) HP | 力量 (STR) | 初始护甲 (BLK) | 状态描述 |
| :--- | :--- | :--- | :--- | :--- |
| **第 1 层 (L0)** | 30 | 0 | 0 | 基础难度，教学关卡 |
| **第 5 层 (L4)** | 48 | 1 | 4 | 难度适中，敌人开始拥有防御 |
| **第 10 层 (Boss)** | 352 | 5 | 13 | 极高挑战，需要强力功法组合 |

## 3. 游戏流程进阶 (Post-Boss)
- **破境重圆**: 击败 Boss 并通过“雷劫”后，系统会自动重新生成一张全新的地图。
- **难度继承**: 重新生成的地图将开启下一境界的修行，难度将从该境界的基础值开始重新计算。

## 4. 回归测试保障
为了确保后续开发不破坏核心体验，我们建立了以下回归防线：
- **场景稳定性**: 严禁修改 `src/plugins/mod.rs` 中的 `setup_camera` 和 `setup_combat_environment` 坐标。
- **路径逻辑**: 更新了 `tests/victory_e2e.rs`，使其适配拓扑连线地图的解锁机制。
- **加载稳定性**: 修复了读档时的竞态条件，确保“继续修行”百分之百进入地图。

## 5. 验证命令
```bash
# 运行难度基线测试
cargo test --test difficulty_baseline_tdd

# 运行全量胜利流程回归
cargo test --test victory_e2e
```

## 6. 状态确立 (2026-01-29)
| **验证模块** | **测试文件** | **状态** | **备注** |
| :--- | :--- | :--- | :--- |
| **难度缩放** | `tests/difficulty_baseline_tdd.rs` | PASS | 验证 HP/STR/BLK 随层级增长 |
| **地图路径** | `tests/victory_e2e.rs` | PASS | 适配拓扑连线解锁逻辑 |
| **系统修复** | `tests/map_system_fixes.rs` | PASS | 验证事件节点连通性 |
| **资源初始化** | `tests/victory_rewards_tdd.rs` | PASS | 验证 PlayerDeck 初始 13 张卡 |
| **场景稳定性** | N/A | LOCKED | 确认为改动摄像机与场景坐标 |

**当前所有 100+ 集成测试均已通过，正式确立为 feat/map-difficulty-scaling 分支的基线版本。**
