# Azure Pipelines configuration for Jiujie: Dujie (Bevy Game)
# Target: Windows MSI via cargo-wix

trigger:
  branches:
    include:
      - main
  tags:
    include:
      - v*

pool:
  vmImage: 'windows-latest'

variables:
  RUST_BACKTRACE: 1
  # 指定 Rust 工具链版本
  RUST_TOOLCHAIN: stable

steps:
# 1. 安装 Rust
- script: |
    curl -sSf -o rustup-init.exe https://win.rustup.rs
    rustup-init.exe -y --default-toolchain %RUST_TOOLCHAIN% --default-host x86_64-pc-windows-msvc
    echo "##vso[task.prependpath]%USERPROFILE%\.cargo\bin"
  displayName: 'Install Rust'

# 2. 缓存 Cargo (加速构建)
- task: Cache@2
  inputs:
    key: 'cargo | "$(Agent.OS)" | Cargo.toml'
    restoreKeys: |
       cargo | "$(Agent.OS)"
    path: $(USERPROFILE)/.cargo/registry
  displayName: Cache Cargo Registry

# 3. 安装 cargo-wix (使用 cargo install 配合缓存，或者直接下载二进制)
# 考虑到 Azure 环境没有预装 cargo-wix，我们直接 cargo install，依赖缓存来加速后续构建
- script: |
    cargo install cargo-wix --version 0.3.8
  displayName: 'Install cargo-wix'

# 4. 构建并生成 MSI
# cargo wix 会自动执行 cargo build --release
- script: |
    cargo wix --no-build --nocapture
    # 如果你也想让它执行 release 构建，去掉 --no-build。
    # 鉴于我们需要 release 二进制，标准的命令是：
    cargo wix --release
  displayName: 'Build Release and Create MSI'

# 5. 查找并发布 MSI 文件
- task: CopyFiles@2
  inputs:
    SourceFolder: 'target/wix'
    Contents: '*.msi'
    TargetFolder: '$(Build.ArtifactStagingDirectory)'
  displayName: 'Copy MSI to Staging'

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'JiujieInstaller'
    publishLocation: 'Container'
  displayName: 'Publish MSI Artifact'
